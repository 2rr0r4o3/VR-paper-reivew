# Return to sender: Detecting kernel exploits with eBPF

1. 소개 (Introduction)
이 논문은 eBPF(Extended Berkeley Packet Filter)를 사용하여 Linux 커널의 취약점을 탐지하고 방어하는 방법을 다룬다. 발표자는 Datadog의 시니어 보안 엔지니어 Guillaume Fournier로, 클라우드 워크로드 보안 및 eBPF를 활용한 위협 탐지에 중점을 두고 있다.

2. eBPF란 무엇인가? (What is eBPF?)
eBPF는 Linux 커널에서 샌드박스된 프로그램을 실행할 수 있는 기능을 제공한다. 이를 통해 커널 내의 다양한 이벤트를 모니터링하고, 시스템 콜을 후킹하거나, 네트워크 패킷을 필터링하는 등의 작업이 가능하다.

3. 왜 eBPF인가? (Why eBPF?)
폭넓은 커널 지원: eBPF 기능에 따라 Linux 커널 4.1 이상에서 지원된다.
시스템 안전성 및 안정성 보장: 커널 내에서 안전하게 실행된다.
풍부한 기능 세트: 쉽게 사용할 수 있는 인트로스펙션 기능을 제공한다.
일부 쓰기 접근 및 실행 강제 기능: 커널 내에서 일부 쓰기 작업과 강제 기능을 제공한다.

4. KRIe: SMEP & SMAP on a budget

4.1 공격 시나리오 1: 공격자가 커널에서 다음으로 실행될 명령어의 주소를 제어할 수 있는 경우
Return Object Programming (ROP) 공격: 전형적인 사용 사례
권한 상승 공격: 공격자가 커널 명령어의 주소를 제어하여 임의의 커널 코드를 실행한다.

4.2 SMEP 및 SMAP 사용 예제
SMEP: CPU가 사용자 공간 실행 메모리에서 코드를 실행하지 못하도록 방지한다.
ROP 체인 예제

```
xchg esp, eax ; ret
push %rbp
@rop_chain
@gadget_1
0x42
@kernel_func
```

이 ROP 체인은 최종적으로 commit_creds(prepare_kernel_cred(0))를 호출하여 루트 권한을 획득한다.

4.3 budget으로 SMEP 및 SMAP 구현
BPF_PROG_TYPE_KPROBE를 prepare_kernel_cred에 배치하여 스택 포인터, 프레임 포인터 및 명령어 포인터 레지스터가 사용자 공간 메모리를 가리키는지 확인한다.

```
echo 0 > /sys/kernel/debug/kprobes/enabled
sysctl kernel.ftrace_enabled=0
```

5. 커널 보안 구성 (Kernel Security Configuration)
Kprobes 비활성화:
```
echo 0 > /sys/kernel/debug/kprobes/enabled
```

이 명령은 머신의 모든 kprobe를 비활성화한다. ROP 체인은 이를 호출하여 kprobe를 비활성화할 수 있다.
대응 방법: kprobe를 무작위 오프셋에 배치하여 함수 자체를 trap으로 만든다.

6. 커널 런타임 변조 (Kernel Runtime Alterations)

6.1 공격 시나리오 2: 공격자가 머신에서 루트 권한을 획득하고 커널 런타임을 변조하여 지속적인 접근을 유지하려는 경우

모니터링 항목:
모든 bpf() 작업 및 BPF 필터 삽입
커널 모듈 로드/삭제 이벤트
k(ret)probe 등록/삭제/활성화/비활성화 이벤트
ptrace 이벤트
sysctl 명령
후킹된 시스템 콜의 실행

6.2 예제 코드
시스템 콜 테이블 주기적 검사:
```
struct bpf_perf_event_data {
    // 이벤트 데이터 구조체
};
int check_syscall_table(struct bpf_perf_event_data *ctx) {
    // 시스템 콜 테이블 검사 로직
}
```

7. 제어 흐름 무결성 (Control Flow Integrity)
7.1 CFI 구현
실행 흐름 잠금: 런타임에 호출 지점을 제어하여 커널의 실행 흐름을 잠근다.
목표: 민감한 함수로의 악의적인 호출을 감지하고, 접근 권한 관련 논리 버그를 탐지한다.
문제점: 후크 지점 제한 및 번거로운 과정

8. 성능 (Performance)
8.1 성능 테스트 결과
Linux 커널 컴파일 시간:
```
사용자 공간 CPU 시간   커널 공간 CPU 시간   총 소요 시간
KRIe 사용 전: 4,320s (88%), 568s (12%), 5:53.14
KRIe 사용 후: 4,517s (68%), 2,097s (32%), 8:15.76
```

9. 결론 (Conclusion)
a.eBPF를 활용한 강력한 방어 도구 구현 가능
b. eBPF는 커널 익스플로잇 탐지에 이상적인 기술은 아님
c. KRIe는 현실적으로 최후의 수단이며, 완벽한 해결책은 아님

이 논문은 eBPF를 활용하여 Linux 커널의 취약점을 탐지하고 방어하는 방법을 구체적이고 자세하게 설명하며, 여러 공격 시나리오와 방어 기법을 포함한다.

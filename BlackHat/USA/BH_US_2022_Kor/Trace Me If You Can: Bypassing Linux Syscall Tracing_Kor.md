# Trace Me If You Can: Bypassing Linux Syscall Tracing

사건 발생 - 공격자의 관점

joe-box에서 Log4shell RCE 발생
초기 공격 벡터: Log4shell(CVE-2021-44228) 취약점을 이용해 원격 코드 실행(RCE) 달성.
페이로드: 역방향 셸(reverse shell)을 실행하여 시스템을 장악.

권한 상승
방법: sudo 취약점 CVE-2021-3156(Baron Samedit)를 이용해 표준 사용자에서 루트로 권한 상승.
명령어: /etc/shadow 파일에 접근하여 암호 해시와 같은 민감한 정보를 읽음.

수평 이동
목표: SSH 세션을 가로채서 다른 시스템(alice-box)으로 이동.
기술: SSH 프로세스의 환경 변수를 읽어 연결을 가로챔.
요약: 공격자는 Log4shell 취약점을 이용해 RCE를 달성하고, sudo 취약점을 통해 권한을 상승시키며, SSH 세션을 가로채어 네트워크 내 여러 시스템을 장악함.

사건 발생 - 방어자의 관점

Log4shell RCE 탐지
침해 지표(IOC): 역방향 셸 활동 및 /etc/shadow와 같은 민감한 파일에 대한 비정상적인 읽기 작업을 모니터링.
로그 및 경고: execve, open, connect 등의 시스템 호출을 로깅하여 사건 대응.

사건 대응
격리: 침해된 시스템(joe-box 및 alice-box)을 격리.
복구: Log4shell 및 sudo 취약점을 패치하고, 침해된 자격 증명을 회전시키며, 깨끗한 백업에서 시스템을 복원.
요약: 방어자는 시스템 호출 추적을 통해 공격을 식별하고, 영향을 받은 시스템을 격리하며, 패치를 적용하고, 운영을 복구함. 이는 지속적인 모니터링과 신속한 대응의 중요성을 강조함.

시스템 호출 추적
추적 프로그램 개요

목적: 시스템 호출 데이터(인수 및 반환값 포함)를 수집.
메커니즘: tracepoints, kprobe, ptrace와 같은 다양한 훅을 사용.
Tracepoints: 커널 내 정적 훅으로 낮은 오버헤드를 가지지만 유연성이 제한됨.
Kprobe: 커널 내 동적 훅으로 더 높은 유연성을 제공하지만 성능 비용이 높음.
Ptrace: 높은 오버헤드를 가진 정적 훅으로 보통 seccomp와 결합하여 성능 영향을 줄임.

구현 예

리눅스 기본 메커니즘: ftrace와 perf_events.
커널 모듈 및 eBPF 프로브: 유연하고 효율적인 추적 제공.
유저 공간 프로그램: ptrace를 활용한 strace와 같은 도구.

시스템 호출 추적의 TOCTOU
TOCTOU(검사 시간에서 사용 시간으로)의 취약성
개념: 자원 검사가 이루어진 시점(TOC)과 자원을 사용하는 시점(TOU) 사이의 시간 차이에서 발생하는 경쟁 상태.
예시: sys_connect 시스템 호출은 이 단계를 악용하여 사용자 공간 포인터를 변경할 수 있음.

상세 흐름
TOC: 추적 프로그램이 사용자 공간 포인터를 역참조.
TOU: 커널이 동일한 포인터를 역참조하여 악의적으로 변경된 이후 사용될 수 있음.

완화 전략
비교: sys_enter와 sys_exit 지점에서 시스템 호출 인수를 비교하여 불일치를 탐지.
도구: 커널 모듈/eBPF 또는 ptrace 기반 pdig를 사용하는 Falco와 같은 도구를 활용하여 시스템 호출을 모니터링.

탐지 규칙 예시 코드
```
rule: untrusted program reads /etc/shadow
condition:
  syscall == open(at)
  and has read permission
  and filename == /etc/shadow
  and program is not in allowlist

```

악용 및 완화

악용 전략
팬텀 공격(DEFCON 29): userfaultfd 시스템 호출을 사용하여 작은 지연을 도입해 모니터링을 회피.
완화: userfaultfd 시스템 호출을 탐지하고 차단.
지연 주입: 시스템 호출 실행 시간을 훨씬 초과하는 지연을 도입해 정밀한 제어를 불필요하게 만듦.
완화: 시스템 호출을 제한하는 seccomp 규칙을 적용하고 시스템 호출 패턴을 분석.
영향을 받는 시스템 호출 범주

파일 시스템: open(at), creat, rename(at), mkdir(at), rmdir 등.
프로세스 관리: fork, exec, wait 등.
네트워킹: connect, accept, socket 등.
보안: seccomp, keyctl 등.

완화 기술 요약
Seccomp 필터: 시스템 호출을 인수 값 및 시퀀스에 따라 제한하는 seccomp 필터 적용.
인수 비교: 시스템 호출의 진입 및 종료 지점에서 인수를 비교.
커널 메모리 모니터링: BPF-LSM과 같은 리눅스 보안 모듈을 사용하여 커널 메모리 및 시스템 호출 인수를 모니터링.

핵심 요약
우회 가능성: 리눅스 커널 추적은 신뢰할 수 있게 우회될 수 있으므로, 보안 도구의 지속적인 검증이 필요.
복잡한 완화: 완화 전략은 워크로드 유형 및 커널 호환성에 따라 다양함.
데이터 소스 상호 연관: 포괄적인 보안 모니터링을 위해 여러 데이터 소스를 연관시켜야 함.
기본 상태 이해: 시스템의 정상 동작을 이해하여 이상 징후를 효과적으로 식별.

본 발표는 리눅스 시스템 호출 추적을 우회하는 기술적 세부 사항과 완화 전략을 다루며, 공격자와 방어자의 관점을 모두 포함한다.

# Android Universal Root: Exploiting xPU Drivers

1. 소개 (Introduction)
본 발표는 안드로이드 디바이스에서 xPU(예: GPU, DSP) 드라이버를 통한 루팅 익스플로잇을 탐구한다. 이 연구는 실제 환경에서 발견된 사례와 내부 연구 결과를 포함하며, 안드로이드 파트너 취약점 이니셔티브(Android Partner Vulnerability Initiative)의 일부로 진행되었다.

2. 오래된 드라이버 취약점 (Old Driver Vulnerabilities)
mtk-su 익스플로잇

- MediaTek 장치에서 루팅을 위해 사용되는 도구이다.
- XDA Developers 포럼에서 주로 발견되었다.

3. CMDQ_IOCTL_EXEC_COMMAND 익스플로잇 (CMDQ_IOCTL_EXEC_COMMAND Exploit)
역공학 및 익스플로잇 분석

- 명령어: CMDQ_IOCTL_EXEC_COMMAND
  - 사용자가 커널로 명령어 버퍼를 전송한다.
  - 명령어 형식: CMDQ_CODE_ENUM
- 취약점: CVE-2020-0069
- 참고 자료: CMDQ Core 헤더 파일 (https://android.googlesource.com/kernel/mediatek/+/android-mtk-3.18/drivers/misc/mediatek/cmdq/hv1/cmdq_core.h#245)

```
#define CMDQ_IOCTL_EXEC_COMMAND _IOWR(CMDQ_IOC_MAGIC, 10, struct cmdqRecStruct)
struct cmdqRecStruct {
    uint64_t engineFlag;
    uint32_t blocksize;
    uint32_t thread;
    uint32_t priority;
    uint32_t scen;
    uint32_t userDebugStr[2];
    void __user *userData;
};
```

4. SELinux 정책을 통한 접근 제한 (SELinux Policy Restriction)
SELinux Fix
- 장치 노드에 접근하지 못하도록 제한하였다.
- 접근 제어 정책 업데이트를 통해 SELinux를 강화하였다.

5. GPU 드라이버: 완벽한 로컬 공격 표면 (GPU Driver: Perfect Local Attack Surface)
공격 표면 분석

- 비특권 사용자가 GPU 드라이버에 접근하는 것을 제한할 수 없다.
- GPU 디바이스 드라이버는 많은 기능을 사용자 공간에 제공한다.
  - ARM: Mali
  - Qualcomm: Adreno
  - Imagination Technologies: PowerVR

시장 점유율
PowerVR GPU는 MediaTek과 UniSoc 장치에 널리 사용되어 가장 큰 시장 점유율을 가진다.

6. Bridge API 소개 (Introduction to Bridge APIs)
Bridge API 동작
- 비특권 사용자가 PowerVR GPU 드라이버에 접근할 수 있다.
- PowerVR GPU 드라이버는 수백 개의 커널 함수를 사용자 공간에 제공한다. 이를 Bridge 함수라고 한다.
- 세 단계로 구성된다:
  - 디바이스 열기
  - ioctl 코드와 인수 전송
  - 응답 수신

7. Bridge API의 힙 오버플로우 (Heap Overflow in Bridge APIs)
취약점 설명

Bridge API PVRSRVBridgeSyncPrimOpTake 호출 시 힙 오버플로우 발생:
- 그룹 ID: 2, 함수 ID: 9
- 입력 데이터 구조: PVRSRV_BRIDGE_IN_SYNCPRIMOPTAKE
- 사용자 입력에 따라 커널 버퍼 크기 계산 중 정수 오버플로우 발생

```
typedef struct {
    IMG_UINT32 ui32SyncCount;
    PVRSRV_SYNC_PRIMITIVE_BLOCK **apsSyncPrimBlock;
    IMG_UINT32 *aui32SyncOffset;
    IMG_UINT32 *aui32Flags;
} PVRSRV_BRIDGE_IN_SYNCPRIMOPTAKE;
```

8. Bridge API의 경쟁 조건 (Race Condition in Bridge APIs)

경쟁 조건 설명
내부 커널 함수를 호출하여 객체 생성, 사용, 해제 과정을 거친다.
예시:
- Bridge API X: 커널 객체 생성, 계산에 사용, 사용자에게 핸들 반환
- Bridge API Y: 핸들로 커널 객체 찾기, 참조 카운트 감소

9. Bridge API의 초기화되지 않은 힙 메모리 읽기 (Read Uninitialized Heap Memory in Bridge APIs)

취약점 설명
커널 객체를 초기화하고 사용자 공간으로 데이터를 복사하는 과정에서 발생
초기화 실패 시 초기화되지 않은 데이터가 사용자 공간으로 복사됨
이는 커널 힙 포인터 또는 KASLR 우회에 사용될 수 있음

10. PowerVR 메모리 관리: GPU VA ↔ PA (PowerVR Memory Management: GPU VA ↔ PA)
메모리 관리 분석
PMR (Physical Memory Resource)
- Bridge API 호출을 통해 PMR 핸들을 얻고 이를 통해 GPU/CPU 가상 메모리를 매핑
- 물리 페이지와 가상 페이지의 수, 메모리 속성 등을 정의

```
typedef struct {
    IMG_HANDLE hPMR;
    IMG_UINT32 ui32Flags;
    IMG_UINT32 ui32NumOfPages;
} PMR;
```

11. PowerVR 메모리 관리: 고정 메모리 (Pinned Memory)
고정 메모리 설명
- 고정 메모리는 장치에서 호스트로 데이터 전송 시 사용됨
- PVRSRVBridgeDevmemIntPin 및 PVRSRVBridgeDevmemIntUnpin 함수를 통해 물리 페이지를 고정 또는 해제

취약점 설명
CVE-2022-20122: Unpin API를 통한 임의 페이지 해제
- 코드 정적 분석 도구를 위한 PVR_ASSERT 매크로가 실제 프로덕션 코드에서는 아무 작업도 하지 않음

```
#define PVR_ASSERT(expr) do { \
    if (!(expr)) { \
        printk(KERN_ERR "Assertion failed: %s\n", #expr); \
    } \
} while (0)
```

12. PowerRoot: 루팅 (PowerRoot: Root)

루팅 방법 설명

CVE-2021-39815을 통해 다양한 방법으로 디바이스를 루팅
- 페이지 테이블 손상
- 바이너리 손상
- 메모리 손상 공격을 통해 커널 공격

루팅 과정

- task_struct 검색하여 cred 구조체 찾기
- 임의 읽기/쓰기 스팸 파일 생성
- 커널 이미지를 덤프하여 SELinux 설정 우회

13. 안드로이드 파트너 취약점 이니셔티브 (Android Partner Vulnerability Initiative)

APVI 설명
- 2020년 말 시작된 Google의 보안 이니셔티브
- AOSP 코드 외부의 보안 문제를 식별하고 해결
- 52개의 보안 문제 공개: APVI Issue Tracker

벤더 패치 및 공개 프로세스
- Imagination Technologies와 안드로이드 OEM 파트너에게 공개
- APVI Issue Tracker에 공개하여 투명성 증대

14. 드라이버 개발자 및 연구자 권장사항 (Recommendations for Driver Developers and Researchers)

드라이버 개발자
- 드라이버 목적과 설계에 대한 보안 검토
- 퍼징 테스트 및 코드 리뷰
- 최소한의 접근 권한으로 잠금

연구자
- xPU는 CPU/xPU 메모리 가시성 문제를 도입
- PowerVR은 연구가 부족한 상태

# The Most Dangerous Codec in the World: Finding and Exploiting Vulnerabilities in H.264 Decoders

1. 소개 (Introduction)
이 자료는 H.264 비디오 디코더의 취약성을 찾고 이를 악용하는 방법을 다룬다. H.264는 널리 사용되는 비디오 압축 표준으로, 다양한 장치와 소프트웨어에서 사용된다. 이 발표는 특히 H.264 디코딩 과정에서 발생할 수 있는 다양한 취약점을 탐구하고, 이를 악용하는 방법을 설명한다.

2. 배경 (Background)
H.264 또는 AVC(Advanced Video Codec)는 ITU와 MPEG에서 공동으로 개발한 비디오 압축 표준이다. H.264는 높은 압축 효율과 품질을 제공하며, 다양한 응용 프로그램에서 사용된다. H.264 비트스트림은 네트워크 추상화 계층 단위(NALUs)로 나뉘며, 각 NALU는 시작 코드(00 00 00 01)로 구분된다. NALUs는 비디오 프레임을 구성하는 여러 유형의 데이터를 포함하며, 각 데이터는 구문 요소로 구성된다.

H.264 비트스트림 구조
NALU (Network Abstraction Layer Units): 비디오 데이터의 기본 단위로, 시작 코드와 페이로드로 구성된다.
구문 요소 (Syntax Elements): NALU 내의 데이터로, 다양한 비디오 인코딩 정보를 포함한다. 예를 들어, 슬라이스 헤더, 매크로블록 데이터 등이 있다.

3. 공격 표면 (Attack Surface)
비디오 디코딩은 응용 프로그램, 커널 드라이버, 전용 하드웨어 등 다양한 환경에서 수행된다. 이러한 과정에서 발생할 수 있는 취약점은 광범위하며, 다양한 공격 표면을 제공한다. 특히, 하드웨어 디코더는 많은 공급 업체에서 제공되며, 각 디코더는 고유한 커널 드라이버를 통해 제어된다.

예시
Apple A11 SoC: AppleD5500.kext 드라이버를 사용하여 하드웨어 디코딩을 제어한다.
Apple A12 SoC 및 M1 Mac: AppleAVD.kext 드라이버를 사용하여 하드웨어 디코딩을 제어한다.

4. H26Forge 도구 (H26Forge Toolkit)
H26Forge는 H.264 디코더의 복잡성을 탐색하고 취약성을 찾기 위해 개발된 도구이다. 이 도구는 Rust 언어로 작성되었으며, H.264 비트스트림을 조작하여 다양한 테스트 케이스를 생성할 수 있다. 이를 통해 다양한 환경에서 취약점을 발견할 수 있다.

주요 기능
비트스트림 조작: H.264 비트스트림 내의 구문 요소를 편집하여 다양한 테스트 케이스를 생성한다.
자동화된 테스트: 다양한 디코더와 환경에서 자동화된 테스트를 수행하여 취약점을 찾는다.

5. 취약점 분석 (Vulnerability Analysis)
이 섹션에서는 AppleD5500.kext에서 발견된 CVE-2022-32939를 예로 들어 취약점의 원인과 악용 방법을 설명한다.

CVE-2022-32939: 힙 오버플로우
원인: NALU 구문 요소에서 발생하는 힙 오버플로우 문제이다. 에뮬레이션 방지 바이트(EPB)의 처리에서 경계 검사가 누락되어 발생한다. EPB는 비트스트림 내에서 00 00 00 01 시퀀스가 나타나는 것을 방지하기 위해 삽입되는 바이트이다.
버그 메커니즘:
EPB 배열의 경계 검사가 없으면, 256개 이상의 EPB가 배열 인덱스를 덮어쓸 수 있다.
이는 힙 오버플로우로 이어져 메모리 손상을 일으킬 수 있다.

6. 실증 시연 (Proof of Concept)
이 섹션에서는 CVE-2022-32939를 악용한 실증 시연을 다룬다. 유효한 길이의 NALU와 최소 258개의 EPB를 포함하는 비디오를 생성하여 취약점을 악용한다.

단계별 설명
비디오 생성: H26Forge를 사용하여 유효한 길이의 NALU와 최소 258개의 EPB를 포함하는 비디오 파일을 생성한다.
테스트: 이 비디오 파일을 iOS 13.3이 설치된 iPhone SE에서 실행하여 디코딩 과정에서 크래시가 발생하는지 확인한다.
결과 확인: 비디오 썸네일링 과정에서 크래시가 발생하면, EPB 배열의 경계 검사 누락으로 인한 힙 오버플로우 취약점을 확인할 수 있다.

7. 결론 (Conclusion)
비디오 디코더의 복잡성은 상당하며, 비디오 디코딩 공격 표면은 탐색하기 어렵다. H26Forge와 같은 도구는 이러한 복잡성을 이해하고 취약점을 발견하는 데 중요한 역할을 한다. 앞으로 더 많은 코덱과 비디오 인프라가 이러한 도구를 통해 보안성이 향상될 수 있다. 이 발표는 H.264 디코더의 복잡성과 이를 악용하는 방법을 탐구하며, 새로운 도구와 기법을 통해 비디오 디코딩 과정에서의 보안 취약점을 효과적으로 발견하고 해결할 수 있는 가능성을 제시한다.

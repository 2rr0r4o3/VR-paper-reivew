# Austin Emmitt - Apple's Predicament NSPredicate Exploitation on macOS and iOS

---

Introduction
Austin Emmitt는 Vigilant Labs의 취약성 연구원으로, Trellix Advanced Research Center에서 연구를 수행하였다. 연구는 FORCEDENTRY라는 0-클릭 iMessage 익스플로잇을 시작으로, JBIG2 이미지 코덱 코드의 정수 오버플로우를 악용하여 NSPredicate를 사용해 샌드박스를 탈출하는 방법을 분석하였다. 이 익스플로잇은 NSExpression 및 NSPredicateOperator 인스턴스를 이용해 샌드박스를 우회하였다.

Background: Why is hacking iOS so hard?
iOS는 다음과 같은 여러 보안 기능을 가지고 있다:

ASLR (Address Space Layout Randomization): 메모리 주소를 무작위로 배치하여 공격자가 메모리 레이아웃을 예측하기 어렵게 한다.
엄격한 코드 서명: 승인된 코드만 실행되도록 보장하여 악성 코드의 실행을 방지한다.
PAC (Pointer Authentication Codes): 포인터에 서명하여 포인터의 무결성을 검사하며, 변조된 포인터 사용을 방지한다.
샌드박스: 각 애플리케이션이 독립된 샌드박스 환경에서 실행되어 다른 애플리케이션과 격리된다.
Background: Objective-C
Objective-C는 C 언어의 상위 집합으로, Smalltalk와 유사한 객체 지향 프로그래밍을 지원한다. 주요 특징은 메시지 패싱 기법을 사용하여 메서드를 호출하는 것으로, 이는 컴파일 시가 아닌 런타임에 결정된다. 이로 인해 메서드 교체와 같은 런타임 조작이 가능하여 메모리 취약점 공격에 유리하다. 예를 들어, Objective-C의 objc_msgSend 함수는 런타임에 메서드를 동적으로 호출하며, 공격자는 이 메커니즘을 악용하여 임의의 메서드를 실행할 수 있다.

What is an NSPredicate?
NSPredicate는 검색 및 필터링을 위한 논리 조건을 정의하는 문자열이다. NSPredicate는 NSExpression과 NSPredicateOperator 인스턴스를 사용하여 내부적으로 표현된다. 예를 들어, 'grade == "7"' 또는 'firstName LIKE "Juan" && age < 16'와 같은 조건을 정의할 수 있다. 이는 SQL의 WHERE 절과 유사하게 동작하며, 다양한 조건식과 논리 연산을 포함할 수 있다.

Quick Explainer: XPC
XPC는 iOS와 macOS에서 가장 일반적인 프로세스 간 통신 메커니즘이다. XPC는 한 프로세스가 다른 프로세스의 메서드를 호출할 수 있도록 하며, 데이터를 안전하게 교환할 수 있도록 한다. NSPredicate는 XPC 호출에서 결과를 필터링하는 데 자주 사용된다. XPC는 고성능 통신을 위해 설계되었으며, 병렬 처리와 비동기 실행을 지원한다.

Anatomy of an NSPredicate
NSPredicate는 NSExpression과 NSPredicateOperator 인스턴스를 사용하여 구축된다. NSExpression은 키 경로, 함수 호출, 상수 등을 포함할 수 있으며, 이는 형식 문자열에서 구문 분석되어 NSPredicate 객체로 변환된다. NSPredicateOperator는 비교 연산, 논리 연산 등의 연산자를 나타내며, 이는 NSPredicate의 핵심 논리를 구성한다.

What can an NSPredicate do?
NSPredicate는 Objective-C 런타임을 완전히 동적으로 스크립팅할 수 있다. FUNCTION 키워드를 사용하여 객체의 메서드를 호출할 수 있으며, keyPath 표현식도 인수를 취하지 않는 메서드 시퀀스를 실행할 수 있다. 예를 들어, 'FUNCTION(foo, "bar:")'는 foo 객체의 bar: 메서드를 호출한다. 이를 통해 공격자는 NSPredicate를 이용하여 다양한 런타임 조작을 수행할 수 있다. NSPredicate의 동적 특성은 특히 보안 우회에 유용하다.

Bypassing NSPredicate Mitigations
NSPredicate의 보안 정책 플래그는 CoreFoundation으로 이동되었으며, 여러 위험한 유형이 간과되었다. 예를 들어, char* 유형 "*"을 통해 -[NSString getCString:] 메서드를 사용하여 동일한 종류의 임의 쓰기를 수행할 수 있었다. NSPredicate는 다양한 데이터 유형과 연산을 지원하므로, 이를 악용하여 메모리 쓰기와 같은 위험한 작업을 수행할 수 있다. 이 과정에서 NSPredicate의 동적 평가 메커니즘을 이용해 공격자가 임의 코드를 실행할 수 있는 가능성이 존재한다.

Exploiting iOS Daemons
coreduetd, contextstored, appstored, OSLogService, SpringBoard 등의 다양한 데몬이 NSPredicate를 통해 익스플로잇될 수 있었다. 예를 들어, coreduetd 데몬은 사용자의 활동 데이터를 기록하며, contextstored 데몬은 위치 데이터를 관리한다. 이러한 데몬을 익스플로잇하면 악성 앱이 애플리케이션, 위치 및 알림 데이터를 포함한 메시지 내용을 액세스할 수 있었다. 이 과정에서 NSPredicate를 사용해 데이터 필터링과 메서드 호출을 동적으로 조작할 수 있었다.

Conclusion
Apple은 이제 NSPredicate가 객체를 반환하고 객체 인수를 받는 함수 표현만 허용하도록 심각하게 제한하기 시작하였지만, 앞으로도 NSPredicate는 유용한 익스플로잇 도구로 남아 있을 것이다. 앞으로의 보안 정책은 NSPredicate의 남용을 방지하는 데 중점을 두어야 한다. 이를 통해 NSPredicate의 동적 평가 특성을 악용한 공격을 차단하고, 시스템의 보안성을 강화할 필요가 있다.
